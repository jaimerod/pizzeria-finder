<!-- Base elements -->
<link rel="import" href="../lib/polymer/polymer.html" />
<link rel="import" href="../lib/paper-card/paper-card.html" />
<link rel="import" href="pizza-detail.html">

<dom-module id="pizza-details">
  <template>
    <style></style>
    <template
      is="dom-repeat"
      items="{{details}}"
      as="detail"
      filter="{{_filter(openFilter, deliveryFilter)}}"
      sort="{{_sort(sorting)}}">
      <pizza-detail
        placeid="{{detail.place_id}}"
        address="{{detail.vicinity}}"
        pid="{{detail.id}}"
        name="{{detail.name}}"
        photos="{{detail.photos}}"
        rating="{{detail.rating}}">
      </pizza-detail>
    </template>
  </template>
  <script>
    Polymer({
      is: "pizza-details",
      properties: {
        details: {
          type: Array
        },
        sorting: {
          type: String,
          value: 'alpha'
        },
        openFilter: {
          type: Boolean,
          value: false
        },
        deliveryFilter: {
          type: Boolean,
          value: false
        }
      },

      ready: function () {
        this.addEventListener('sortDetailsRating', () => {
          this.sorting = 'rating';
        });

        this.addEventListener('sortDetailsAlpha', () => {
          this.sorting = 'alpha';
        });

        this.addEventListener('filterDetailsOpened', () => {
          this.openFilter = !this.openFilter;
        });

        this.addEventListener('filterDetailsDelivery', () => {
          this.deliveryFilter = !this.openFilter;
        });
      },

      _filter: (open, deliver) => {
        return (item) => {
          let hasRating = typeof item.rating !== "undefined";
          let hasPhoto = typeof item.photos !== "undefined";
          let filter = hasRating && hasPhoto;
          let isOpened = typeof item.opening_hours !== "undefined" && item.opening_hours.open_now;
          let delivers = !!item.types.filter((value) => {
            return value == 'meal_delivery';
          }).length;

          if (deliver) {
            filter = filter && delivers;
          }

          if (open) {
            filter = filter && isOpened;
          }

          return filter;
        }
      },

      _sort: (val) => {
        if (val === "rating") {
          return (a, b) => {
            if (a.rating === b.rating) return 0;
            return (a.rating > b.rating) ? -1 : 1;
          }
        }

        return (a, b) => {
          if (a.name === b.name) return 0;
          return (a.name < b.name) ? -1 : 1;
        }
      }
    });
  </script>
</dom-module>