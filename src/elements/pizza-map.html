<!-- Base elements -->
<link rel="import" href="../lib/polymer/polymer.html" />
<link rel="import" href="../lib/google-map/google-map.html">
<link rel="import" href="pizza-details.html">
<link rel="import" href="pizza-add-review.html">
<link rel="import" href="pizza-reviews.html">
<link rel="import" href="pizzeria-marker.html">

<dom-module id="pizza-map">
  <template>
    <style></style>
    <pizza-details details="{{pizzerias}}"></pizza-details>
    <pizza-reviews></pizza-reviews>
    <pizza-add-review></pizza-add-review>
  </template>
  <script>
    Polymer({
      is: 'pizza-map',

      properties: {
        pizzerias: {
          type: Array
        }
      },

      ready: function () {
        this.addEventListener('showReviews', this.showReviews);
        this.addEventListener('showAddReview', this.showAddReview);
        this.addEventListener('sortRating', this.sortRating);
        this.addEventListener('sortAlpha', this.sortAlpha);
        this.addEventListener('filterOpened', this.filterOpened);
        this.addEventListener('filterDeliver', this.filterDeliver);

        // Check if we cached the Pizzerias
      /*  if (window.localStorage && false) {
          var Pizzerias = localStorage.getItem('Pizzerias');
          if (Pizzerias) {
            that.pizzerias = JSON.parse(Pizzerias);
            return;
          }
        }*/

        // We didn't cache them, let's download some
        let Pizzerias = fetch('https://jaime.rodriguez-jr.com/places.php');

        Pizzerias.then((response) => {
          if (response.status !== 200) {
            console.log('Looks like there was a problem. Status Code: ' +  response.status);
            return;
          }

          // It worked!  Let's do stuff...
          response.text().then((responseText) => {
            this.pizzerias = JSON.parse(responseText);
            localStorage.setItem('Pizzerias', responseText);
          });
        })
      },

      showReviews: function (event) {
        let ReviewsDialog = this.$$('pizza-reviews');
        ReviewsDialog.pid = event.detail.pid;
        ReviewsDialog.reviews = event.detail.reviews;
      },

      showAddReview: function (event) {
        let addReviewDialog = this.$$('pizza-add-review');
        addReviewDialog.pid = event.detail.pid;
        addReviewDialog.show();
      },

      sortAlpha: function (event) {
        this.$$('pizza-details').fire('sortDetailsAlpha');
      },

      sortRating: function (event) {
        this.$$('pizza-details').fire('sortDetailsRating');
      },

      filterOpened: function (event) {
        this.$$('pizza-details').fire('filterDetailsOpened');
      },

      filterDeliver: function (event) {
        this.$$('pizza-details').fire('filterDetailsDelivery');
      }
    });
  </script>
</dom-module>