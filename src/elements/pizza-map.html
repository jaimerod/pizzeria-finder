<!-- Base elements -->
<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="pizza-details.html">
<link rel="import" href="pizza-add-review.html">
<link rel="import" href="pizza-reviews.html">
<link rel="import" href="pizzeria-marker.html">

<dom-module id="pizza-map">
  <template>
    <style>
      google-map {
        height: 400px;
        margin-bottom: 8px;
      }
    </style>
    <google-map
      map="{{map}}"
      api-key="AIzaSyBP6G38hX2uoNcjAHAUMQOYx1Uqv1z6PnQ"
      latitude="34.05992193978781"
      longitude="-118.2607514819336"
      zoom="13"
      disable-default-ui>
      <template is="dom-repeat" items="{{pizzerias}}" as="pizzeria">
        <pizzeria-marker map="{{map}}" details="{{pizzeria}}"></pizzeria-marker>
      </template>
    </google-map>

    <pizza-details details="{{pizzerias}}"></pizza-details>
    <pizza-reviews></pizza-reviews>
    <pizza-add-review></pizza-add-review>
  </template>
  <script>
    Polymer({
      is: 'pizza-map',
      properties: {
        pizzerias: {
          type: Array
        }
      },
      ready: function () {
        var that = this;

        this.addEventListener('showReviews', this.showReviews);
        this.addEventListener('showAddReview', this.showAddReview);

        // Check if we cached the Pizzerias
        if (window.localStorage) {
          var Pizzerias = localStorage.getItem('Pizzerias');
          if (Pizzerias) {
            that.pizzerias = JSON.parse(Pizzerias);
            return;
          }
        }

        // We didn't cache them, let's download some
        var Pizzerias = fetch('https://jaime.rodriguez-jr.com/places.php');

        Pizzerias.then(function (response) {
          if (response.status !== 200) {
            console.log('Looks like there was a problem. Status Code: ' +  response.status);
            return;
          }

          // It worked!  Let's do stuff...
          response.text().then(function (responseText) {
            that.pizzerias = JSON.parse(responseText);
            localStorage.setItem('Pizzerias', responseText);
          });
        })
      },
      showReviews: function (event) {
        console.dir(event);
        var ReviewsDialog = this.$$('pizza-reviews');
        ReviewsDialog.pid = event.detail.pid;
        //ReviewsDialog.show();
      },
      showAddReview: function (event) {
        var addReviewDialog = this.$$('pizza-add-review');
        addReviewDialog.pid = event.detail.pid;
        addReviewDialog.show();
      }
    });
  </script>
</dom-module>